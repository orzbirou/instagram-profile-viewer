<!-- Search Header (always visible) -->
<div class="search-header">
  <div class="search-container">
    <div class="search-wrapper">
      <app-search-input 
        [value]="searchTerm()" 
        (valueChange)="onSearchTermChange($event)"
      />
      
      <app-search-results-dropdown 
        [isOpen]="searchTerm().trim().length >= 2" 
        [results]="searchResults()"
        [isLoading]="isSearchLoading()"
        [error]="searchError()"
        (select)="onSelectUsername($event)"
        (close)="onCloseDropdown()"
      />
    </div>
  </div>
</div>

<!-- Profile Content -->
@if (!username()) {
  <!-- Idle state - no profile selected -->
  <div class="idle-state">
    <div class="idle-content">
      <h1 class="idle-title">Instagram Profile Viewer</h1>
      <p class="idle-subtitle">Search for a user to view their profile</p>
    </div>
  </div>
} @else if (loading()) {
  <div class="loading">
    Loading profile...
  </div>
} @else if (error()) {
  <div class="error">
    {{ error() }}
  </div>
} @else if (profile()) {
  <div class="page">
    <div class="profile-top-shell">
      <div class="profile-container">
        <app-profile-header 
          [profile]="profile()!" 
          (profilePictureClick)="openStories()" 
        />
    
    <!-- Highlights section -->
    <app-profile-highlights
      [highlights]="highlights()"
      [isLoading]="highlightsLoading()"
      [error]="highlightsError()"
      (retry)="retryHighlights()"
      (highlightClick)="openHighlight($event.id, $event.title)"
    />
      </div>
    </div>
    
    <div class="grid-shell">
    <div class="ig-tabs">
      <button 
        class="ig-tab" 
        [class.is-active]="selectedTab() === 'posts'"
        (click)="setTab('posts')"
        type="button"
        aria-label="Posts">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
          <rect x="3" y="3" width="7" height="7"/>
          <rect x="14" y="3" width="7" height="7"/>
          <rect x="3" y="14" width="7" height="7"/>
          <rect x="14" y="14" width="7" height="7"/>
        </svg>
      </button>
      
      <button 
        class="ig-tab" 
        [class.is-active]="selectedTab() === 'reels'"
        (click)="setTab('reels')"
        type="button"
        aria-label="Reels">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
          <path d="M2.5 5.5A1.5 1.5 0 014 4h16a1.5 1.5 0 011.5 1.5v13a1.5 1.5 0 01-1.5 1.5H4a1.5 1.5 0 01-1.5-1.5v-13zm2 0v13H20v-13H4.5z"/>
          <path d="M9.5 8.5l6 4-6 4v-8z"/>
        </svg>
      </button>
      
      <button 
        class="ig-tab" 
        [class.is-active]="selectedTab() === 'tagged'"
        (click)="setTab('tagged')"
        type="button"
        aria-label="Tagged">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
          <path d="M10.5 8.5a2 2 0 114 0 2 2 0 01-4 0z"/>
          <path d="M3 4a1 1 0 011-1h16a1 1 0 011 1v16a1 1 0 01-1 1H4a1 1 0 01-1-1V4zm2 1v14h14V5H5z"/>
          <path d="M12.5 13.5a3 3 0 00-3 3v2h6v-2a3 3 0 00-3-3z"/>
        </svg>
      </button>
      
      <button 
        class="ig-tab" 
        [class.is-active]="selectedTab() === 'reposts'"
        (click)="setTab('reposts')"
        type="button"
        aria-label="Reposts">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
          <path d="M19 7v4H5.83l3.58-3.59L8 6l-6 6 6 6 1.41-1.41L5.83 13H21V7h-2z"/>
        </svg>
      </button>
    </div>
    
    <!-- Posts content based on selectedTab -->
    @if (selectedTab() === 'posts') {
      @if (tabError()) {
        <div class="error-state" style="padding: 40px 20px; text-align: center;">
          <p style="color: #ed4956; margin: 0 0 16px 0;">{{ tabError() }}</p>
          <button 
            style="padding: 8px 16px; background: #0095f6; color: white; border: none; border-radius: 4px; cursor: pointer;"
            (click)="loadPosts({ reset: true })">
            Retry
          </button>
        </div>
      } @else if (isLoading() && items().length === 0) {
        <div class="loading-state" style="padding: 40px 20px; text-align: center; color: #8e8e8e;">
          Loading posts...
        </div>
      } @else if (items().length > 0) {
        <div class="posts-grid ig-grid">
          @for (item of items(); track item.code) {
            <div 
              class="post-item ig-tile"
              (click)="openPost(item.code)">
              <img 
                [src]="getProxyImageUrl(item.displayUrl)" 
                [alt]="'Post ' + item.code"
                style="width: 100%; height: 100%; object-fit: cover;">
            </div>
          }
        </div>
        
        @if (isLoading() && items().length > 0) {
          <div style="text-align: center; margin: 32px 0; color: #8e8e8e; font-size: 14px;">
            Loading more...
          </div>
        }
        
        <!-- Infinite scroll sentinel -->
        <div #infiniteSentinel class="infinite-sentinel"></div>
      } @else {
        <div class="empty-state" style="padding: 40px 20px; text-align: center; color: #8e8e8e;">
          No posts yet
        </div>
      }
    } @else if (selectedTab() === 'reels') {
      @if (tabError()) {
        <div class="error-state" style="padding: 40px 20px; text-align: center;">
          <p style="color: #ed4956; margin: 0 0 16px 0;">{{ tabError() }}</p>
          <button 
            style="padding: 8px 16px; background: #0095f6; color: white; border: none; border-radius: 4px; cursor: pointer;"
            (click)="loadReels({ reset: true })">
            Retry
          </button>
        </div>
      } @else if (isLoading() && items().length === 0) {
        <div class="loading-state" style="padding: 40px 20px; text-align: center; color: #8e8e8e;">
          Loading reels...
        </div>
      } @else if (items().length > 0) {
        <div class="posts-grid ig-grid">
          @for (item of items(); track item.code) {
            <div 
              class="post-item ig-tile reel-item"
              (click)="openReelViewerByItem(item)">
              <img 
                [src]="getProxyImageUrl(item.displayUrl)" 
                [alt]="'Reel ' + item.code"
                style="width: 100%; height: 100%; object-fit: cover;">
              <!-- Video overlay indicator -->
              <div style="position: absolute; top: 8px; right: 8px; width: 24px; height: 24px; background: rgba(0,0,0,0.6); border-radius: 4px; display: flex; align-items: center; justify-content: center;">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="white" style="margin-left: 2px;">
                  <path d="M8 5v14l11-7z"/>
                </svg>
              </div>
            </div>
          }
        </div>
        
        @if (isLoading() && items().length > 0) {
          <div style="text-align: center; margin: 32px 0; color: #8e8e8e; font-size: 14px;">
            Loading more...
          </div>
        }
        
        <!-- Infinite scroll sentinel -->
        <div #infiniteSentinel class="infinite-sentinel"></div>
      } @else {
        <div class="empty-state" style="padding: 40px 20px; text-align: center; color: #8e8e8e;">
          No reels yet
        </div>
      }
    } @else if (selectedTab() === 'tagged') {
      @if (tabError()) {
        <div class="error-state" style="padding: 40px 20px; text-align: center;">
          <p style="color: #ed4956; margin: 0 0 16px 0;">{{ tabError() }}</p>
          <button 
            style="padding: 8px 16px; background: #0095f6; color: white; border: none; border-radius: 4px; cursor: pointer;"
            (click)="loadTagged({ reset: true })">
            Retry
          </button>
        </div>
      } @else if (isLoading() && items().length === 0) {
        <div class="loading-state" style="padding: 40px 20px; text-align: center; color: #8e8e8e;">
          Loading tagged posts...
        </div>
      } @else if (items().length > 0) {
        <div class="posts-grid ig-grid">
          @for (item of items(); track item.code) {
            <div 
              class="post-item ig-tile"
              (click)="openPost(item.code)">
              <img 
                [src]="getProxyImageUrl(item.displayUrl)" 
                [alt]="'Tagged post ' + item.code"
                style="width: 100%; height: 100%; object-fit: cover;">
            </div>
          }
        </div>
        
        @if (isLoading() && items().length > 0) {
          <div style="text-align: center; margin: 32px 0; color: #8e8e8e; font-size: 14px;">
            Loading more...
          </div>
        }
        
        <!-- Infinite scroll sentinel -->
        <div #infiniteSentinel class="infinite-sentinel"></div>
      } @else {
        <div class="empty-state" style="padding: 40px 20px; text-align: center; color: #8e8e8e;">
          No tagged posts yet
        </div>
      }
    } @else if (selectedTab() === 'reposts') {
      @if (tabError()) {
        <div class="error-state" style="padding: 40px 20px; text-align: center;">
          <p style="color: #ed4956; margin: 0 0 16px 0;">{{ tabError() }}</p>
          <button 
            style="padding: 8px 16px; background: #0095f6; color: white; border: none; border-radius: 4px; cursor: pointer;"
            (click)="loadReposts({ reset: true })">
            Retry
          </button>
        </div>
      } @else if (isLoading() && items().length === 0) {
        <div class="loading-state" style="padding: 40px 20px; text-align: center; color: #8e8e8e;">
          Loading reposts...
        </div>
      } @else if (items().length > 0) {
        <div class="posts-grid ig-grid">
          @for (item of items(); track item.code) {
            <div 
              class="post-item ig-tile"
              (click)="openPost(item.code)">
              <img 
                [src]="getProxyImageUrl(item.displayUrl)" 
                [alt]="'Repost ' + item.code"
                style="width: 100%; height: 100%; object-fit: cover;">
            </div>
          }
        </div>
        
        @if (isLoading() && items().length > 0) {
          <div style="text-align: center; margin: 32px 0; color: #8e8e8e; font-size: 14px;">
            Loading more...
          </div>
        }
        
        <!-- Infinite scroll sentinel -->
        <div #infiniteSentinel class="infinite-sentinel"></div>
      } @else {
        <div class="empty-state" style="padding: 40px 20px; text-align: center; color: #8e8e8e;">
          No reposts yet
        </div>
      }
    }
    </div>
  </div>
}

<!-- Post Detail Modal -->
@if (selectedPostCode()) {
  <div class="modal-overlay" (click)="closePost()">
    <div class="modal-dialog" (click)="$event.stopPropagation()">
      <button class="modal-close" (click)="closePost()" type="button" aria-label="Close">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
          <path d="M18.3 5.71a.996.996 0 00-1.41 0L12 10.59 7.11 5.7A.996.996 0 105.7 7.11L10.59 12 5.7 16.89a.996.996 0 101.41 1.41L12 13.41l4.89 4.89a.996.996 0 101.41-1.41L13.41 12l4.89-4.89c.38-.38.38-1.02 0-1.4z"/>
        </svg>
      </button>

      @if (postLoading()) {
        <div class="modal-loading">Loading post...</div>
      } @else if (postError()) {
        <div class="modal-error">
          <p>{{ postError() }}</p>
          <button 
            (click)="openPost(selectedPostCode()!)" 
            [disabled]="!selectedPostCode()"
            type="button">Retry</button>
        </div>
      } @else if (post()) {
        <div class="modal-content">
          <!-- Left: Media -->
          <div class="modal-media">
            @if (post()!.mediaType === 'VIDEO' || post()!.videoUrl) {
              <video 
                [src]="post()!.videoUrl || post()!.displayUrl"
                controls
                style="width: 100%; height: 100%; object-fit: contain;">
              </video>
            } @else {
              <img 
                [src]="post()!.displayUrl" 
                [alt]="'Post by ' + post()!.user.username"
                style="width: 100%; height: 100%; object-fit: contain;">
            }
          </div>

          <!-- Right: Details -->
          <div class="modal-sidebar">
            <!-- User header -->
            <div class="modal-user-header">
              <img 
                [src]="post()!.user.profilePicUrl" 
                [alt]="post()!.user.username"
                class="modal-avatar">
              <span class="modal-username">{{ post()!.user.username }}</span>
            </div>

            <!-- Caption -->
            <div class="modal-caption-section">
              <div class="modal-caption-user">
                <img 
                  [src]="post()!.user.profilePicUrl" 
                  [alt]="post()!.user.username"
                  class="modal-caption-avatar">
                <div class="modal-caption-content">
                  <span class="modal-caption-username">{{ post()!.user.username }}</span>
                  <span class="modal-caption-text">{{ post()!.captionText }}</span>
                </div>
              </div>
            </div>

            <!-- Comments section -->
            <div class="modal-comments">
              @if (!postLoading() && post()) {
                @if (comments().length > 0) {
                  @for (comment of comments(); track comment.id) {
                    <div class="modal-comment">
                    <img 
                      [src]="comment.user.profilePicUrl" 
                      [alt]="comment.user.username"
                      class="modal-comment-avatar">
                    <div class="modal-comment-content">
                      <span class="modal-comment-username">{{ comment.user.username }}</span>
                      <span class="modal-comment-text">{{ comment.text }}</span>
                      <div class="modal-comment-meta">
                        <span>{{ comment.likeCount }} likes</span>
                      </div>
                    </div>
                  </div>
                }

                @if (commentsHasMore() && !commentsLoading()) {
                  <button 
                    class="modal-load-more-comments" 
                    (click)="loadMoreComments()"
                    type="button">
                    Load more comments
                  </button>
                }

                @if (commentsLoading()) {
                  <div class="modal-comments-loading">Loading comments...</div>
                }
                } @else if (commentsLoading()) {
                  <div class="modal-comments-loading">Loading comments...</div>
                } @else {
                  <div class="modal-comments-empty">No comments yet</div>
                }
              }
            </div>

            <!-- Post meta -->
            <div class="modal-meta">
              <div class="modal-stats">
                <span>{{ post()!.likeCount }} likes</span>
                <span>{{ post()!.commentCount }} comments</span>
              </div>
            </div>
          </div>
        </div>
      }
    </div>
  </div>
}

<!-- Reels Viewer (reuses post modal structure) -->
@if (isReelViewerOpen() && reelViewerCode() && currentReelItem()) {
  <div class="modal-overlay" (click)="closeReelViewer()">
    <div class="modal-dialog" (click)="$event.stopPropagation()">
      <button class="modal-close" (click)="closeReelViewer()" type="button" aria-label="Close">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
          <path d="M18.3 5.71a.996.996 0 00-1.41 0L12 10.59 7.11 5.7A.996.996 0 105.7 7.11L10.59 12 5.7 16.89a.996.996 0 101.41 1.41L12 13.41l4.89 4.89a.996.996 0 101.41-1.41L13.41 12l4.89-4.89c.38-.38.38-1.02 0-1.4z"/>
        </svg>
      </button>

      <!-- Previous arrow (overlay style) -->
      @if (reelViewerIndex() > 0) {
        <button class="reel-viewer-arrow reel-viewer-arrow-prev" (click)="prevReel()" type="button" aria-label="Previous Reel">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
            <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/>
          </svg>
        </button>
      }

      <!-- Next arrow (overlay style) -->
      @if (reelViewerIndex() < items().length - 1 || moreAvailable()) {
        <button class="reel-viewer-arrow reel-viewer-arrow-next" (click)="nextReel()" type="button" aria-label="Next Reel">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
            <path d="M8.59 16.59L10 18l6-6-6-6-1.41 1.41L13.17 12z"/>
          </svg>
        </button>
      }

      @if (reelResolvedLoading()) {
        <div class="modal-loading">Loading reel...</div>
      } @else if (reelResolvedError()) {
        <div class="modal-error">
          <p>{{ reelResolvedError() }}</p>
          <button 
            (click)="resolveReelMedia(reelViewerCode()!)" 
            type="button">Retry</button>
        </div>
      } @else {
        <div class="modal-content">
          <!-- Left: Media -->
          <div class="modal-media">
            @if (reelVideoError()) {
              <div style="color: #8e8e8e; text-align: center; padding: 40px 20px;">
                <p style="margin: 0 0 8px 0;">Video temporarily unavailable.</p>
                @if (currentReelItem()?.displayUrl) {
                  <img 
                    [src]="getProxyImageUrl(currentReelItem()!.displayUrl)"
                    [alt]="'Reel thumbnail ' + currentReelItem()!.code"
                    style="max-width: 100%; max-height: 400px; margin-top: 16px; object-fit: contain;">
                }
              </div>
            } @else if (currentReelItem()?.videoUrl || reelResolvedVideoUrl()) {
              <video 
                [src]="currentReelItem()?.videoUrl || reelResolvedVideoUrl()!"
                controls
                autoplay
                muted
                playsinline
                (error)="onReelVideoError()"
                style="width: 100%; height: 100%; object-fit: contain;">
              </video>
            } @else if (reelResolvedDisplayUrl() || currentReelItem()?.displayUrl) {
              <img 
                [src]="getProxyImageUrl(reelResolvedDisplayUrl() || currentReelItem()!.displayUrl)"
                [alt]="'Reel ' + currentReelItem()!.code"
                style="width: 100%; height: 100%; object-fit: contain;">
            } @else {
              <div style="color: #8e8e8e; text-align: center; padding: 20px;">
                Media unavailable
              </div>
            }
          </div>

          <!-- Right: Details & Comments -->
          <div class="modal-sidebar">
            <!-- User header (placeholder - will be populated from resolved media) -->
            <div class="modal-user-header">
              <div class="modal-avatar" style="background: #dbdbdb; border-radius: 50%;"></div>
              <span class="modal-username">{{ username() }}</span>
            </div>

            <!-- Comments section -->
            <div class="modal-comments">
              @if (comments().length > 0) {
                @for (comment of comments(); track comment.id) {
                  <div class="modal-comment">
                    <img 
                      [src]="comment.user.profilePicUrl" 
                      [alt]="comment.user.username"
                      class="modal-comment-avatar">
                    <div class="modal-comment-content">
                      <span class="modal-comment-username">{{ comment.user.username }}</span>
                      <span class="modal-comment-text">{{ comment.text }}</span>
                      <div class="modal-comment-meta">
                        <span>{{ comment.likeCount }} likes</span>
                      </div>
                    </div>
                  </div>
                }

                @if (commentsHasMore() && !commentsLoading()) {
                  <button 
                    class="modal-load-more-comments" 
                    (click)="loadMoreComments()"
                    type="button">
                    Load more comments
                  </button>
                }

                @if (commentsLoading()) {
                  <div class="modal-comments-loading">Loading comments...</div>
                }
              } @else if (commentsLoading()) {
                <div class="modal-comments-loading">Loading comments...</div>
              } @else {
                <div class="modal-comments-empty">No comments yet</div>
              }
            </div>

            <!-- Reel meta -->
            <div class="modal-meta">
              <div class="modal-stats">
                @if (currentReelItem()!.likeCount) {
                  <span>{{ currentReelItem()!.likeCount }} likes</span>
                }
                @if (currentReelItem()!.commentCount) {
                  <span>{{ currentReelItem()!.commentCount }} comments</span>
                }
              </div>
            </div>
          </div>
        </div>
      }
    </div>
  </div>
}

<!-- Stories Viewer -->
@if (storiesOpen()) {
  <div class="stories-overlay" (click)="closeStories()" (keydown)="handleStoriesKeyboard($event)" tabindex="0">
    <div class="stories-container" (click)="$event.stopPropagation()">
      <!-- Close button -->
      <button class="stories-close" (click)="closeStories()" type="button" aria-label="Close Stories">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="white">
          <path d="M18.3 5.71a.996.996 0 00-1.41 0L12 10.59 7.11 5.7A.996.996 0 105.7 7.11L10.59 12 5.7 16.89a.996.996 0 101.41 1.41L12 13.41l4.89 4.89a.996.996 0 101.41-1.41L13.41 12l4.89-4.89c.38-.38.38-1.02 0-1.4z"/>
        </svg>
      </button>

      @if (storiesLoading()) {
        <div class="stories-loading">Loading stories...</div>
      } @else if (storiesError()) {
        <div class="stories-error">
          <p>{{ storiesError() }}</p>
          <button (click)="closeStories()" type="button">Close</button>
        </div>
      } @else if (currentStory()) {
        <!-- Progress bars -->
        <div class="stories-progress">
          @for (story of stories(); track story.id; let i = $index) {
            <div class="stories-progress-bar" [class.active]="i === storyIndex()" [class.completed]="i < storyIndex()"></div>
          }
        </div>

        <!-- User header -->
        @if (storiesUser()) {
          <div class="stories-user">
            <img [src]="storiesUser()!.profilePicUrl" [alt]="storiesUser()!.username" class="stories-avatar">
            <span class="stories-username">{{ storiesTitle() || storiesUser()!.username }}</span>
          </div>
        }

        <!-- Story media -->
        <div class="stories-media">
          @if (currentStory()!.mediaType === 2 && currentStory()!.videoUrl) {
            <video 
              [src]="currentStory()!.videoUrl"
              controls
              autoplay
              playsinline
              style="width: 100%; height: 100%; object-fit: contain;">
            </video>
          } @else {
            <img 
              [src]="currentStory()!.imageUrl"
              [alt]="'Story ' + currentStory()!.id"
              style="width: 100%; height: 100%; object-fit: contain;">
          }
        </div>

        <!-- Click zones for navigation -->
        <div class="stories-nav-left" (click)="prevStory()"></div>
        <div class="stories-nav-right" (click)="nextStory()"></div>
      }
    </div>
  </div>
}
